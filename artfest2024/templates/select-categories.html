{% extends "main.html" %}
{% load static %}
{% block content %}
  <head>
    <link rel="stylesheet" type="text/css" href="{% static 'css/select-categories.css' %}">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <style>
      #toast-container {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
      }
    
      .toast {
        width: 300px;
      }
     
    </style>
  </head>
  
  
  <div class="toast-container" id="toast-container">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-autohide="true" data-delay="2000">
      <div class="toast-header">
        <strong class="mr-auto">Notification</strong>
        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="toast-body">
        <!-- Toast body content will be dynamically added here -->
      </div>
    </div>
  </div>
  

  <div class="container-fluid cat-container">
    {% if userdetails %}
      <div class="user-info col-md-6">
        <table border='2' class="table table-bordered">
          <tr>
            <th>Name:</th>
            <td>{{ userdetails.student_name }}</td>
          </tr>
          <tr>
            <th>Admission Number:</th>
            <td>{{ userdetails.student_admn_no }}</td>
          </tr>
          <tr>
            <th>Phone:</th>
            <td>{{ userdetails.student_phone }}</td>
          </tr>
          <tr>
            <th>Email:</th>
            <td>{{ userdetails.student_email }}</td>
          </tr>
          <tr>
            <th>House Name:</th>
            <td>{{ userdetails.house_name }}</td>
          </tr>
          <tr>
            <th>Gender:</th>
            <td>{{ userdetails.Gender }}</td>
          </tr>
        </table>
      </div>
    {% else %}
      <p class="col-12 text-center">No User Details Found.</p>
    {% endif %}
  </div>
  {% if programs %}
    <h2 class="text-center">Select categories</h2>
    <form method="post" action="{% url 'select_categories' %}">
      {% csrf_token %}
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="thead-primary">
            <tr>
              <th>Program Name</th>
              <th>Program Type</th>
              <th>Stage Type</th>
              <th>Gender Category</th>
              <th>Select your preference</th>
            </tr>
          </thead>
          <tbody>
            {% for program in programs %}
              {% if program.show_program == True %}
                <tr>
                  <td>
                    <label for="{{ program.program_name }}">{{ program.program_name }}</label>
                  </td>
                  <td>{{ program.program_type }}</td>
                  <td>{{ program.Stage_choices }}</td>
                  <td>{{ program.Gender_choices }}</td>
                  <td>
                    {% if program in userdetails.program.all %}
                      <input class="form-check-input text-center mr-2 shadow" type="checkbox" value="{{ program.program_name }}" name="selected_programs" checked>
                    {% else %}
                      <input class="form-check-input text-center mr-2 shadow" type="checkbox" value="{{ program.program_name }}" name="selected_programs">
                    {% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="text-center">
        <button type="submit" class="btn btn-primary mt-8" style="width:80%;">Submit Your Choices</button>
      </div>
    </form>
  {% else %}
    <h2 class="text-center text-danger"> No registrations For Now</h2>
  {% endif %}
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'assets/js/select-categories.js' %}"></script>
  <script>

  document.addEventListener('DOMContentLoaded', function () {
    showToast("welcome",3000,'info');
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    let soloCount = 0;
    let groupCount = 0;

    checkboxes.forEach(function (checkbox) {
        const programType = checkbox.parentNode.previousElementSibling.previousElementSibling.previousElementSibling.textContent.trim();

        // Initialize counts based on pre-checked checkboxes
        if (checkbox.checked) {
            if (programType === 'individual' && soloCount < 4) {
                soloCount++;
            } else if (programType === 'Group' && groupCount < 2) {
                groupCount++;
            }
        }
    });


    checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
            const programType = this.parentNode.previousElementSibling.previousElementSibling.previousElementSibling.textContent.trim();

            // Display toast for each selection
            if (this.checked) {
                if (programType === 'individual' && soloCount < 4) {
                    soloCount++;
                } else if (programType === 'Group' && groupCount < 2) {
                    groupCount++;
                } else {
                    this.checked = false; // Prevent checking more than the allowed limit
                    showToast('A student can only participate in up to 4 solo items and 2 group items',5000,'danger');
                }
            } else {
                if (programType === 'individual') {
                    soloCount--;
                } else if (programType === 'Group') {
                    groupCount--;
                }
            }

            console.log('Current soloCount:', soloCount);
            console.log('Current groupCount:', groupCount);
        });
    });

    function showToast(message, delay = 5000, bgColor = 'success') {
      const toastContainer = document.getElementById('toast-container');
      const toastBody = toastContainer.querySelector('.toast-body');
      toastBody.textContent = message;
  
      const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'), {
          delay: delay
      });
  
      // Customize background color
      toastContainer.querySelector('.toast').classList.remove('bg-success', 'bg-danger');
      toastContainer.querySelector('.toast').classList.add(`bg-${bgColor}`);
  
      // Handle close button click manually
      const closeButton = toastContainer.querySelector('.close');
      closeButton.addEventListener('click', function () {
          toast.hide();
      });
  
      toast.show();
  }
  
});
</script>
{% endblock %}
